---
title: "R Notebook"
output: html_notebook
---


This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r echo=FALSE}
library(tidyverse)
library(factoextra)
library(smacof)
library(phangorn)
library(pvclust)
library(tsne)
library(MASS)
library(vegan)
library(tidyr)
library(effects)
library(lme4)
library(rgl)
library(lmerTest)
# help for DissM ------------------------------------------------------
div_count <- function(string1, string2){
  x <- unlist(string1, use.names = F)
  y <- unlist(string2, use.names = F)
  d <- data.frame(x, y)
  #print(d)
  num <- sum(complete.cases(d))
  return(num)
}

# dissimilarity matrix -------------------------------------------------
dist_count <- function(data) {
  data2 <- data.frame()
  for (i in row.names(data)) {
    for (j in row.names(data)) {
      #print(data[i,])
      #print(data[j,])
      data2[i,j] = round(sum((data[i,]!=data[j,]), na.rm=TRUE)/div_count(data[i,],data[j,]), digits=2)
      #print (round(sum((data[i,]!=data[j,]), na.rm=TRUE)/div_count(data[i,],data[j,]), digits=2))
    }
  }
  return(data2)
}
```
1. Reading data:
```{r echo=FALSE}
turkic <- read.csv("words_sdag_turkic.csv", header = TRUE, sep = ";", na.strings = "NA", row.names = NULL)
row.names(turkic) <- paste(turkic[,1],turkic[,2])
nrow(turkic)
ncol(turkic)
turkic_orig <- turkic
turkic <- turkic[,3:length(turkic)]
turkic_words <- turkic
turkic <- t(turkic)
```

1.1.Converting to long format:
```{r}
turkic_df <- as.data.frame(turkic)
turkic_df$speaker <- rownames(turkic_df)
names(turkic_df)<-str_replace_all(names(turkic_df), c(" " = "." , "," = "" ))
turkic_long <- gather(turkic_df, lexeme, present, the.ant.5:the.year.2, factor_key=TRUE)
View(turkic_long)
turkic_long$lexeme <- as.factor(turkic_long$lexeme)
```
2. Counting dissimilarity matrix
```{r echo=FALSE}
dag <- turkic[-c(7:12,88:93),]
full_dist <- dist_count(dag)
dag <- cbind(row.names(dag), dag)
dag <- as.data.frame(dag)
colnames(dag)[1] <- "village"
dag$village <- as.character(dag$village)
dag$village = substr(dag$village,1,nchar(dag$village)-1)
dag$region[dag$village %in% c("Tsinit", "Arkhit", "Khiv", "Laka", "Khoredzh")] <- "Khiv"
dag$region[dag$village %in% c("Dyubek", "Tatil", "Khapil", "Yagdyg", "Dzhavgat", "Dzhibakhni")] <- "Tabasaran"
dag$region[dag$village %in% c("Tpig", "Kurag", "Khutkhul")] <- "Agul"
dag$region[dag$village %in% c("Rutul", "Khlut", "Kiche", "Ikhrek", "Kina", "Helmets", "Mikik")] <- "Rutul"
dag <- cbind(dag$region, dag)
colnames(dag)[1] <- "region"

word_dist <- dist_count(turkic_words)
head(full_dist)
#full_dist <- as.dist(full_dist)
```
3. Plotting simple hclust
```{r}
plot(hclust(as.dist(word_dist)), cex = 0.5)
hc1 <- hclust(as.dist(word_dist), "ave")
dend <- as.dendrogram(hc1)
dend <- set(dend, "labels_colors", as.numeric(turkic_orig$Lexeme), order_value = TRUE)
dend <- set(dend, "labels_cex", .5)
plot(dend, horiz = F)

hc2 <- (hclust(as.dist(full_dist)))
dend2 <- as.dendrogram(hc2)
dend2 <- set(dend2, "labels_colors", as.numeric(dag$region), order_value = TRUE)
dend <- set(dend2, "labels_cex", .7)
plot(dend2, horiz = F)


hc <- pvclust(as.matrix(full_dist, method.hclust="average", nboot=1000))
plot(hc)


```
CMDScale:
```{r}
data2 <- as.dist(full_dist)
Nnet <- neighborNet(data2)
plot(Nnet, "3D")
DData <- cmdscale(data2, eig=TRUE, k=2)
#iso_DData <- isoMDS(data2)
DData$points[,1] <- (DData$points[,1])^2 * sign(DData$points[,1])
x <- DData$points[,1]
y <- DData$points[,2]
coordinates <- data.frame(x, y)
plot(x, y, xlab="Coordinate 1", ylab="Coordinate 2", main="Southern Villages",  type="n")
text(x, y, labels = row.names(coordinates), cex=.7)
```
t-SNE:
```{r}
library(Rtsne)
## Curating the database for analysis with both t-SNE and PCA


Labels<-dag$region
dag$region<-as.factor(dag$region)
## for plotting
colors = rainbow(length(unique(dag$region)))
names(colors) = unique(dag$region)

turkic_orig$Lexeme<-as.factor(turkic_orig$Lexeme)
word_colors = rainbow(length(unique(turkic_orig$Lexeme)))
names(word_colors) = unique(turkic_orig$Lexeme)

## Executing the algorithm on curated data
dag1 <- na.omit(dag)

tsne1 <- Rtsne(data2, dims = 2, perplexity=2, verbose=TRUE, max_iter = 5000)
tsne2 <- Rtsne(data2, dims = 2, perplexity=5, verbose=TRUE, max_iter = 5000)
tsne3 <- Rtsne(data2, dims = 2, perplexity=10, verbose=TRUE, max_iter = 5000)
tsne4 <- Rtsne(data2, dims = 2, perplexity=25, verbose=TRUE, max_iter = 5000)

words_tsne1 <- Rtsne(as.dist(word_dist), dims = 2, perplexity=5, verbose=TRUE, max_iter = 5000)
words_tsne2 <- Rtsne(as.dist(word_dist), dims = 2, perplexity=15, verbose=TRUE, max_iter = 5000)
words_tsne3 <- Rtsne(as.dist(word_dist), dims = 2, perplexity=30, verbose=TRUE, max_iter = 5000)
words_tsne4 <- Rtsne(as.dist(word_dist), dims = 2, perplexity=50, verbose=TRUE, max_iter = 5000)

## Plotting
plot(word_tsne$Y, t='n', main="tsne")
text(word_tsne$Y, labels=rownames(turkic_orig), col=word_colors[turkic_orig$Lexeme], cex = 0.5)

par(mfrow=c(2,2))
plot(tsne1$Y, t='n', main="perplexity = 2")
text(tsne1$Y, labels=dag$village, col=colors[dag$region])
plot(tsne2$Y, t='n', main="perplexity = 5")
text(tsne2$Y, labels=dag$village, col=colors[dag$region])
plot(tsne3$Y, t='n', main="perplexity = 10")
text(tsne3$Y, labels=dag$village, col=colors[dag$region])
plot(tsne4$Y, t='n', main="perplexity = 25")
text(tsne4$Y, labels=dag$village, col=colors[dag$region])

par(mfrow=c(2,2))
plot(words_tsne1$Y, t='n', main="perplexity = 5")
text(words_tsne1$Y, labels=rownames(turkic_orig), col=colors[dag$region])
plot(words_tsne2$Y, t='n', main="perplexity = 15")
text(words_tsne2$Y, labels=rownames(turkic_orig), col=colors[dag$region])
plot(words_tsne3$Y, t='n', main="perplexity = 30")
text(words_tsne3$Y, labels=rownames(turkic_orig), col=colors[dag$region])
plot(words_tsne4$Y, t='n', main="perplexity = 50")
text(words_tsne4$Y, labels=rownames(turkic_orig), col=colors[dag$region])
```
Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

